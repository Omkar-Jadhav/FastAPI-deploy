
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Strava Summarizer App</title>
  <style>
    /* ... same styles as before ... */

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 10; /* ensure overlay is on top */
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .loading-icon {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-radius: 50%;
      border-top: 5px solid #3498db;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Welcome to Strava Summarizer App!</h1>
    <p>Just one step away from summarizing your activities!</p>
    <button id="getStartedBtn" onclick="getRefreshCode()">Get Started</button>

    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
      <div class="loading-icon"></div>
    </div>

    <div class="info">
      <h2>How It Works</h2>
      <p>This app allows you to generate rolling summaries of your Strava activities and automatically update them in your activity descriptions. Simply click the "Get Started" button above to complete the authorization process.</p>
      <p>Once authorized, the app will retrieve your activities from Strava, calculate rolling summaries, and update your activity descriptions with the latest insights.</p>
      <p>Stay organized and motivated on your fitness journey with our Strava Summarizer App!</p>
    </div>
  </div>
  <script>
    function getRefreshCode(){
        document.getElementById('loadingSpinner').style.display = 'block';

        // Get the current URL
        const currentUrl = window.location.href;
        const baseUrl = window.location.origin

        redirectUrl = 'https://strava-summariser.vercel.app/saveRefreshToken'
        // redirectUrl = 'http://localhost/saveRefreshToken'

        // Parse the current URL
        const parsedUrl = new URL(currentUrl);

        // Extract query parameters efficiently
        const searchParams = parsedUrl.searchParams;

        // Check if the 'code' parameter exists
        if (searchParams.has('code')) {
            // Extract the 'code' parameter value
            const code = searchParams.get('code');
            if (code) {
                // Prepare data for sending to Strava API
                const data = {
                  client_id: '114698', // Replace with your Strava client ID
                  client_secret: '858dd455b9a1d41095727a9285943ec4210810b2', // Replace with your Strava client secret
                  code: code,
                  grant_type: "authorization_code"
                };

                // Send a POST request to Strava API to exchange code for access token
                fetch('https://www.strava.com/oauth/token', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify(data)
                })
                .then(response => {
                  if (!response.ok) {
                    throw new Error(`Strava API error: ${response.status} ${response.statusText}`);
                  }
                  return response.json();
                })
                .then(responseData => {
                  // Log specific details about the response
                  console.log('Strava API response:', responseData);

                  // Send the response data to the local server for further processing
                  fetch(redirectUrl, {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(responseData)
                  })
                  .then(refreshTokenResponse => {
                    if (!refreshTokenResponse.ok) {
                      throw new Error(`Local server error: ${refreshTokenResponse.status} ${refreshTokenResponse.statusText}`);
                    }
                    return refreshTokenResponse.json();
                  })
                  .then(refreshTokenResponseData => {
                    // Redirect to the provided URL if available
                    if (refreshTokenResponseData.redirect_url) {
                      window.location.href = refreshTokenResponseData.redirect_url;
                    } else {
                      console.error('No redirect URL received');
                    }
                  })
                  .catch(error => {
                    console.error('Error saving refresh token:', error);
                  });
                })
                .catch(error => {
                  console.error('Error fetching refresh token:', error);
                });
              }
        }
    }
  </script>
</body>
</html>
